<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Take Exam - Emerging India Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
:root {
    --primary-color: #A6223C;
    --primary-dark: #8A1C32;
    --secondary-color: #6c757d;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --info-color: #17a2b8;
    --warning-color: #ffc107;
    --text-color: #333;
    --bg-light: #f8f9fa;
    --shadow-sm: 0 4px 6px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.1);
    --border-radius: 15px;
    --option-radius: 8px;
}

/* Enhanced fullscreen styles */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f5f5;
    color: var(--text-color);
    overflow-x: hidden;
}

body.exam-mode {
    overflow: hidden !important;
}

/* Prevent text selection and copying */
* {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
}

/* Allow text selection only for specific form inputs */
input[type="text"], 
input[type="password"], 
input[type="email"],
input[type="number"],
textarea {
    -webkit-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
    user-select: text;
    -webkit-touch-callout: default;
}

/* Ensure radio buttons labels remain unselectable */
.form-check-label {
    -webkit-user-select: none !important;
    -moz-user-select: none !important;
    -ms-user-select: none !important;
    user-select: none !important;
    -webkit-touch-callout: none !important;
}

/* Hide scrollbars in fullscreen */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

/* Navbar styles */
.navbar {
    background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 12px 0;
    position: relative;
    z-index: 1100;
}

.navbar-brand {
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* Exam layout styles */
.exam-layout {
    display: flex;
    margin-top: 20px;
    position: relative;
    min-height: calc(100vh - 80px);
}

/* Sidebar styles */
.question-sidebar {
    width: 280px;
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    padding: 20px 0;
    position: fixed;
    top: 80px;
    left: 20px;
    bottom: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    z-index: 1000;
}

.sidebar-header {
    padding: 0 20px 15px;
    border-bottom: 1px solid #eaeaea;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sidebar-title {
    font-size: 1.4rem;
    margin: 0;
    color: var(--primary-dark);
    font-weight: 600;
}

.progress-info {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: 600;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.question-list {
    display: flex;
    flex-direction: column;
    padding: 0 15px;
    flex: 1;
    overflow-y: auto;
}

.question-btn {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px;
    margin-bottom: 8px;
    border: 1px solid #eaeaea;
    border-radius: 8px;
    background-color: white;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.question-btn:hover {
    background-color: #f9f9f9;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.question-btn.current {
    border: 2px solid var(--primary-color);
    background-color: rgba(166, 34, 60, 0.05);
    font-weight: 600;
}

.question-btn.answered {
    border-left: 4px solid var(--success-color);
}

.question-btn.answered .question-status i {
    color: var(--success-color);
}

.question-number {
    font-weight: 600;
    font-size: 1.1rem;
}

.question-status i {
    font-size: 1.1rem;
    color: #ccc;
}

.exam-info {
    padding: 15px 20px;
    border-top: 1px solid #eaeaea;
    margin-top: auto;
    background-color: #f9f9f9;
}

.info-item {
    padding: 8px 0;
    color: var(--secondary-color);
    font-size: 0.95rem;
}

/* Question content styles */
.question-content {
    flex: 1;
    margin-left: 300px;
    margin-right: 20px;
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: calc(100vh - 80px);
}

.exam-header {
    padding: 20px 25px;
    border-bottom: 1px solid #eaeaea;
    background-color: white;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    z-index: 999;
}

.exam-title {
    font-size: 1.6rem;
    margin-bottom: 0;
    color: var(--primary-dark);
    font-weight: 600;
}

.exam-body {
    padding: 25px;
    flex: 1;
    overflow-y: auto;
}

/* Question container styles */
.question-container {
    margin-bottom: 20px;
    animation: fadeIn 0.3s ease-out;
}

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid #eaeaea;
}

.question-text {
    font-size: 1.2rem;
    line-height: 1.6;
    margin-bottom: 20px;
}

/* Options styles */
.options-container {
    margin-top: 25px;
}

.option-container {
    margin-bottom: 15px;
}

.form-check {
    padding: 15px 30px 15px 50px;
    border: 1px solid #eaeaea;
    border-radius: var(--option-radius);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.form-check:hover {
    background-color: #f8f9fa;
    border-color: #d1d1d1;
}

.form-check-input {
    margin-top: 3px;
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.form-check-input:checked + .form-check-label {
    font-weight: 600;
    color: var(--primary-color);
}

.form-check.selected {
    background-color: rgba(166, 34, 60, 0.05);
    border-color: var(--primary-color);
    box-shadow: 0 0 0 1px var(--primary-color);
}

.form-check-label {
    font-size: 1.05rem;
    margin-left: 10px;
    cursor: pointer;
}

/* Question image styles */
.question-image {
    max-width: 100%;
    max-height: 300px;
    margin: 15px 0;
    border-radius: var(--option-radius);
    box-shadow: var(--shadow-sm);
    display: block;
    margin-left: auto;
    margin-right: auto;
}

/* Timer styles */
.timer-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1050;
    background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
    color: white;
    padding: 12px 18px;
    border-radius: var(--option-radius);
    font-size: 1.2rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    animation: pulse 2s infinite;
}

.timer-container i {
    margin-right: 8px;
    font-size: 1.3rem;
}

.timer-container.low-time {
    background: linear-gradient(135deg, #d94642, #dc3545);
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(166, 34, 60, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(166, 34, 60, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(166, 34, 60, 0);
    }
}

/* Navigation buttons */
.question-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
    padding: 15px 0;
    border-top: 1px solid #eaeaea;
}

.navigation-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
    padding: 20px 25px;
    border-top: 1px solid #eaeaea;
    background-color: #f9f9f9;
    border-radius: 0 0 var(--border-radius) var(--border-radius);
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 600;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 10px rgba(166, 34, 60, 0.3);
    transition: all 0.3s;
}

.btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(166, 34, 60, 0.4);
}

.btn-secondary {
    background: linear-gradient(135deg, #6c757d, #495057);
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 600;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 10px rgba(108, 117, 125, 0.3);
    transition: all 0.3s;
}

.btn-secondary:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(108, 117, 125, 0.4);
}

.btn-outline-primary {
    color: var(--primary-color);
    border-color: var(--primary-color);
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s;
}

.btn-outline-primary:hover {
    background-color: var(--primary-color);
    color: white;
    transform: translateY(-2px);
}

.btn-outline-secondary {
    color: var(--secondary-color);
    border-color: var(--secondary-color);
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s;
}

.btn-outline-secondary:hover {
    background-color: var(--secondary-color);
    color: white;
    transform: translateY(-2px);
}

/* Badge styles */
.badge {
    padding: 8px 12px;
    border-radius: 20px;
    font-weight: 500;
    font-size: 0.85rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.badge.bg-primary {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)) !important;
}

.badge.bg-success {
    background: linear-gradient(135deg, #28a745, #20c997) !important;
}

.badge.bg-secondary {
    background: linear-gradient(135deg, #6c757d, #495057) !important;
}

.badge.bg-danger {
    background: linear-gradient(135deg, #dc3545, #c82333) !important;
}

/* Alert styles */
.alert {
    border-radius: var(--border-radius);
    border: none;
    box-shadow: var(--shadow-sm);
    animation: slideInDown 0.5s ease-out;
    padding: 15px 20px;
    margin-bottom: 25px;
}

/* Enhanced warning modal */
.modal-warning {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(220, 53, 69, 0.95);
    color: white;
    z-index: 9999 !important;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 30px;
    text-align: center;
    animation: fadeIn 0.3s ease-out;
    pointer-events: all;
}

.modal-warning * {
    pointer-events: all;
}

.modal-warning h2 {
    font-size: 2rem;
    margin-bottom: 20px;
}

.modal-warning p {
    font-size: 1.2rem;
    margin-bottom: 30px;
    max-width: 600px;
}

.modal-warning .btn {
    padding: 12px 30px;
    font-size: 1.1rem;
    margin-top: 10px;
}

/* Exam instructions modal */
.exam-instructions {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.9);
    color: white;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 30px;
    text-align: center;
}

.instructions-content {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    padding: 40px;
    border-radius: var(--border-radius);
    max-width: 800px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.instructions-content h2 {
    font-size: 2.5rem;
    margin-bottom: 30px;
}

.instructions-list {
    text-align: left;
    font-size: 1.2rem;
    line-height: 1.8;
    margin-bottom: 30px;
}

.instructions-list li {
    margin-bottom: 10px;
    padding-left: 10px;
}

/* Fullscreen lock indicator */
.fullscreen-lock {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    padding: 10px 15px;
    border-radius: 20px;
    font-size: 0.9rem;
    z-index: 1055;
    display: none;
    animation: pulse 2s infinite;
}

.fullscreen-lock.active {
    display: block;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideInDown {
    from {
        transform: translateY(-30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Responsive styles */
@media (max-width: 992px) {
    .question-sidebar {
        width: 240px;
    }
    .question-content {
        margin-left: 260px;
    }
    .form-check {
        padding: 12px 20px 12px 40px;
    }
}

@media (max-width: 768px) {
    .exam-layout {
        flex-direction: column;
    }
    .question-sidebar {
        position: relative;
        top: 0;
        left: 0;
        width: 100%;
        margin: 0 0 20px 0;
        padding: 15px;
        max-height: 300px;
    }
    .question-list {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }
    .question-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .question-btn .question-status {
        display: none;
    }
    .question-content {
        margin-left: 0;
        margin-right: 0;
    }
    .timer-container {
        right: 10px;
        top: 70px;
        padding: 8px 12px;
        font-size: 1rem;
    }
    .timer-container i {
        font-size: 1.1rem;
    }
    .exam-title {
        font-size: 1.3rem;
    }
    .form-check {
        padding: 10px 15px 10px 35px;
    }
}
    </style>
</head>
<body>
<!-- Exam Instructions Modal -->
<div class="exam-instructions" id="examInstructions">
    <div class="instructions-content">
        <h2><i class="fas fa-clipboard-check me-3"></i>Exam Instructions</h2>
        <ul class="instructions-list">
            <li><i class="fas fa-expand-arrows-alt me-2"></i> This exam will run in <strong>fullscreen mode</strong></li>
            <li><i class="fas fa-exclamation-triangle me-2"></i> <strong>Do not</strong> minimize, switch tabs, or exit fullscreen</li>
            <li><i class="fas fa-ban me-2"></i> Right-click, copy, paste, and developer tools are disabled</li>
            <li><i class="fas fa-eye me-2"></i> You have <strong>3 warnings</strong> before automatic submission</li>
            <li><i class="fas fa-wifi me-2"></i> Ensure stable internet connection</li>
            <li><i class="fas fa-clock me-2"></i> Timer will continue running - manage your time wisely</li>
            <li><i class="fas fa-save me-2"></i> Click "Save Progress" regularly to avoid losing answers</li>
        </ul>
        <div class="alert alert-warning mb-4">
            <strong>Warning:</strong> Any attempt to cheat or violate exam rules will result in automatic disqualification.
        </div>
        <button class="btn btn-light btn-lg" onclick="startExam()">
            <i class="fas fa-play me-2"></i> I Understand - Start Exam
        </button>
    </div>
</div>

<!-- Enhanced Warning Modal -->
<div class="modal-warning" id="warningModal" style="display: none;" tabindex="-1">
    <div style="max-width: 600px; text-align: center;">
        <h2><i class="fas fa-exclamation-triangle fa-lg me-2"></i>Security Violation Detected</h2>
        <p>Attempting to exit fullscreen, minimize, or switch applications during the exam is strictly prohibited. This incident has been recorded and logged.</p>
        <button class="btn btn-light" onclick="closeWarningModal()" autofocus>
            <i class="fas fa-arrow-left me-2"></i>Return to Exam
        </button>
        <p class="mt-4">
            <small><strong>Warning <span id="warningCount">1</span> of 3</strong><br>
            After 3 violations, your exam will be automatically submitted.</small>
        </p>
    </div>
</div>

<!-- Fullscreen Lock Indicator -->
<div class="fullscreen-lock" id="fullscreenLock">
    <i class="fas fa-lock me-2"></i> Fullscreen Mode Enforced
</div>

<nav class="navbar navbar-expand-lg navbar-dark" style="display: none;" id="mainNavbar">
    <div class="container">
        <a class="navbar-brand" href="#">Emerging India Analytics</a>
        <div class="ml-auto d-flex align-items-center text-white">
            <i class="fas fa-user-circle me-2"></i> {{ current_user.name }}
        </div>
    </div>
</nav>

<!-- Timer -->
<div class="timer-container" id="timerContainer" style="display: none;">
    <i class="fas fa-clock"></i> <span id="timer">--:--</span>
</div>

<div class="container-fluid" id="examContainer" style="display: none;">
    <div class="exam-layout">
        <!-- Question Numbers Sidebar -->
        <div class="question-sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">Questions</h3>
                <div class="progress-info">
                    <span id="answeredCount">0</span>/<span id="totalQuestions">{{ exam.questions|length }}</span>
                </div>
            </div>

            <div class="question-list">
                {% for question in exam.questions %}
                <button type="button" class="question-btn
                                {% if question.id in answers %}answered{% endif %}
                                {% if loop.index == 1 %}current{% endif %}"
                        onclick="showQuestion({{ loop.index }})" id="questionBtn{{ loop.index }}">
                    <span class="question-number">{{ loop.index }}</span>
                    <span class="question-status">
                        {% if question.id in answers %}
                            <i class="fas fa-check-circle"></i>
                        {% else %}
                            <i class="fas fa-circle"></i>
                        {% endif %}
                    </span>
                    <span class="ms-2" id="reviewIndicator{{ loop.index }}" style="display:none;color:#ffc107;"><i class="fas fa-flag"></i></span>
                </button>
                {% endfor %}
            </div>

            <div class="exam-info">
                <div class="info-item">
                    <i class="fas fa-stopwatch me-2"></i> Duration: {{ exam.duration }} minutes
                </div>
                <div class="info-item">
                    <i class="fas fa-clipboard-list me-2"></i> Total: {{ exam.questions|length }} Questions
                </div>
            </div>
        </div>

        <!-- Question Display Area -->
        <div class="question-content">
            <div class="exam-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="exam-title">{{ exam.title }}</h1>
                    <span class="badge bg-primary"><span id="currentQuestion">1</span> of {{ exam.questions|length }}</span>
                </div>
            </div>

            <div class="exam-body">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
                {% endif %}
                {% endwith %}

                <form method="POST" action="{{ url_for('take_exam', exam_id=exam.id) }}" id="examForm">
                    <!-- Questions -->
                    {% for question in exam.questions %}
                    <div class="question-container" id="question{{ loop.index }}" style="{% if loop.index > 1 %}display: none;{% endif %}">
                        <div class="question-header">
                            <h5><i class="fas fa-question-circle me-2"></i>Question {{ loop.index }}</h5>
                            <span class="badge {% if question.id in answers %}bg-success{% else %}bg-secondary{% endif %}" id="status_{{ question.id }}">
                                {% if question.id in answers %}
                                    <i class="fas fa-check me-1"></i> Answered
                                {% else %}
                                    <i class="fas fa-times me-1"></i> Unanswered
                                {% endif %}
                            </span>
                            <button type="button" class="btn btn-warning btn-sm ms-3" onclick="toggleReview({{ question.id }}, {{ loop.index }})" id="reviewBtn{{ loop.index }}">
                                <i class="fas fa-flag me-1"></i> Mark as Review
                            </button>
                        </div>

                        <p class="question-text">{{ question.question_text }}</p>

                        {% if question.question_image %}
                        <img src="{{ url_for('static', filename='uploads/' + question.question_image) }}"
                             alt="Question image" class="question-image">
                        {% endif %}

                        <div class="options-container mt-4">
                            <div class="option-container">
                                <div class="form-check {% if question.id in answers and answers[question.id] == 'a' %}selected{% endif %}">
                                    <input class="form-check-input" type="radio" name="answer_{{ question.id }}"
                                           id="option_a_{{ question.id }}" value="a"
                                           {% if question.id in answers and answers[question.id] == 'a' %}checked{% endif %}
                                           onchange="updateAnswerStatus({{ question.id }}, {{ loop.index }})">
                                    <label class="form-check-label" for="option_a_{{ question.id }}">
                                        {{ question.option_a }}
                                    </label>
                                </div>
                            </div>

                            <div class="option-container">
                                <div class="form-check {% if question.id in answers and answers[question.id] == 'b' %}selected{% endif %}">
                                    <input class="form-check-input" type="radio" name="answer_{{ question.id }}"
                                           id="option_b_{{ question.id }}" value="b"
                                           {% if question.id in answers and answers[question.id] == 'b' %}checked{% endif %}
                                           onchange="updateAnswerStatus({{ question.id }}, {{ loop.index }})">
                                    <label class="form-check-label" for="option_b_{{ question.id }}">
                                        {{ question.option_b }}
                                    </label>
                                </div>
                            </div>

                            <div class="option-container">
                                <div class="form-check {% if question.id in answers and answers[question.id] == 'c' %}selected{% endif %}">
                                    <input class="form-check-input" type="radio" name="answer_{{ question.id }}"
                                           id="option_c_{{ question.id }}" value="c"
                                           {% if question.id in answers and answers[question.id] == 'c' %}checked{% endif %}
                                           onchange="updateAnswerStatus({{ question.id }}, {{ loop.index }})">
                                    <label class="form-check-label" for="option_c_{{ question.id }}">
                                        {{ question.option_c }}
                                    </label>
                                </div>
                            </div>

                            <div class="option-container">
                                <div class="form-check {% if question.id in answers and answers[question.id] == 'd' %}selected{% endif %}">
                                    <input class="form-check-input" type="radio" name="answer_{{ question.id }}"
                                           id="option_d_{{ question.id }}" value="d"
                                           {% if question.id in answers and answers[question.id] == 'd' %}checked{% endif %}
                                           onchange="updateAnswerStatus({{ question.id }}, {{ loop.index }})">
                                    <label class="form-check-label" for="option_d_{{ question.id }}">
                                        {{ question.option_d }}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Navigation buttons -->
                    <div class="question-navigation">
                        <button type="button" id="prevBtn" class="btn btn-outline-secondary" onclick="navigateToPrevious()">
                            <i class="fas fa-arrow-left me-1"></i> Previous
                        </button>
                        <button type="button" id="nextBtn" class="btn btn-outline-primary" onclick="navigateToNext()">
                            Next <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                    </div>

                    <div class="navigation-buttons">
                        <button type="submit" name="submit_exam" class="btn btn-primary" onclick="return handleFinalSubmit()">
                            <i class="fas fa-paper-plane me-2"></i> Submit Exam
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Mark as Review logic
let reviewQuestions = {};

function toggleReview(questionId, questionNumber) {
    if (reviewQuestions[questionNumber]) {
        reviewQuestions[questionNumber] = false;
        document.getElementById(`reviewIndicator${questionNumber}`).style.display = 'none';
        document.getElementById(`reviewBtn${questionNumber}`).innerHTML = '<i class="fas fa-flag me-1"></i> Mark as Review';
    } else {
        reviewQuestions[questionNumber] = true;
        document.getElementById(`reviewIndicator${questionNumber}`).style.display = 'inline';
        document.getElementById(`reviewBtn${questionNumber}`).innerHTML = '<i class="fas fa-flag me-1"></i> Unmark Review';
    }
}
// Global constants and variables
const MAX_WARNINGS = 3;
let warningCount = 0;
let examDuration = {{ exam.duration }} * 60; // Convert minutes to seconds
let timeRemaining = examDuration;
let timerInterval;
let fullscreenCheckInterval;
let isExamActive = false;
let fullscreenInitialized = false;
let examStarted = false;

// Strict fullscreen enforcement variables
let fullscreenAttempts = 0;
let maxFullscreenAttempts = 5;

/**
 * Start the exam after instructions
 */
function startExam() {
    // Clear any existing exam state
    localStorage.removeItem('exam_{{ exam.id }}_submitted');
    localStorage.removeItem('exam_{{ exam.id }}_in_progress');
    
    document.getElementById('examInstructions').style.display = 'none';
    document.getElementById('mainNavbar').style.display = 'block';
    document.getElementById('timerContainer').style.display = 'flex';
    document.getElementById('examContainer').style.display = 'block';

    examStarted = true;
    isExamActive = true;

    // Initialize all exam components
    initializeExam();
}

/**
 * Initialize the complete exam system
 */
function initializeExam() {
    // Add body class for exam mode
    document.body.classList.add('exam-mode');
    window.warningModalVisible = false;

    // Force initial fullscreen immediately
    forceFullscreen();

    // Initialize text selection and copy protection
    document.addEventListener('selectstart', function(e) {
        const allowedElements = ['input', 'textarea'];
        const allowedTypes = ['text', 'password', 'email', 'number'];
        
        if (!allowedElements.includes(e.target.tagName.toLowerCase()) || 
            (e.target.type && !allowedTypes.includes(e.target.type.toLowerCase()))) {
            e.preventDefault();
            return false;
        }
    });

    // Prevent copy/cut/paste
    document.addEventListener('copy', function(e) {
        e.preventDefault();
        return false;
    });
    
    document.addEventListener('cut', function(e) {
        e.preventDefault();
        return false;
    });
    
    document.addEventListener('paste', function(e) {
        const allowedElements = ['input', 'textarea'];
        if (!allowedElements.includes(e.target.tagName.toLowerCase())) {
            e.preventDefault();
            return false;
        }
    });

    // Initialize fullscreen protection with delay
    setTimeout(() => {
        initializeFullscreenProtection();
        fullscreenInitialized = true;
    }, 2000);

    // Initialize timer
    document.getElementById('timer').textContent = formatTime(examDuration);
    timerInterval = setInterval(updateTimer, 1000);

    // Initialize answered questions count
    updateAnsweredCount();

    // Highlight the first question's button as current
    if (document.getElementById('questionBtn1')) {
        document.getElementById('questionBtn1').classList.add('current');
    }

    // Update navigation buttons for the first question
    const totalQuestions = document.querySelectorAll('.question-container').length;
    updateNavigationButtons(1, totalQuestions);

    // Set up answer change detection
    setupAnswerDetection();

    // Prevent form submission on Enter
    document.getElementById('examForm').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
        }
    });

    // Override submit button behavior
    setupSubmitButtons();

    // Show fullscreen lock indicator
    setTimeout(() => {
        document.getElementById('fullscreenLock').classList.add('active');
    }, 3000);
}

/**
 * Force fullscreen with aggressive retry mechanism
 */
function forceFullscreen() {
    if (warningCount >= MAX_WARNINGS) {
        return; // Don't try to force fullscreen if we've reached max warnings
    }

    if (!isInFullscreen()) {
        const docElm = document.documentElement;

        try {
            if (docElm.requestFullscreen) {
                docElm.requestFullscreen();
            } else if (docElm.webkitRequestFullscreen) {
                docElm.webkitRequestFullscreen();
            } else if (docElm.mozRequestFullScreen) {
                docElm.mozRequestFullScreen();
            } else if (docElm.msRequestFullscreen) {
                docElm.msRequestFullscreen();
            }
        } catch (error) {
            console.error('Error requesting fullscreen:', error);
        }
    }
}

/**
 * Check if currently in fullscreen
 */
function isInFullscreen() {
    return !!(document.fullscreenElement ||
             document.webkitFullscreenElement ||
             document.mozFullScreenElement ||
             document.msFullscreenElement);
}

/**
 * Aggressive fullscreen monitoring and enforcement
 */
function enforceFullscreen() {
    if (!fullscreenInitialized || !examStarted) return;

    if (!isInFullscreen()) {
        if (!window.warningModalVisible) {
            showWarningModal();
        }

        // Only attempt fullscreen if we haven't reached max warnings
        if (warningCount < MAX_WARNINGS) {
            // Immediate fullscreen attempt
            forceFullscreen();

            // Additional attempts with delays
            setTimeout(() => {
                if (!isInFullscreen()) {
                    forceFullscreen();
                }
            }, 500);

            setTimeout(() => {
                if (!isInFullscreen()) {
                    forceFullscreen();
                }
            }, 1500);
        }
    }
}

/**
 * Initialize comprehensive fullscreen protection
 */
function initializeFullscreenProtection() {
    // Comprehensive key blocking
    document.addEventListener('keydown', blockAllDangerousKeys, { capture: true, passive: false });
    document.addEventListener('keyup', blockAllDangerousKeys, { capture: true, passive: false });

    // Multiple fullscreen change listeners
    document.addEventListener('fullscreenchange', enforceFullscreen);
    document.addEventListener('webkitfullscreenchange', enforceFullscreen);
    document.addEventListener('mozfullscreenchange', enforceFullscreen);
    document.addEventListener('MSFullscreenChange', enforceFullscreen);

    // Aggressive visibility monitoring
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden' && isExamActive && fullscreenInitialized) {
            setTimeout(() => {
                if (document.visibilityState === 'hidden' && isExamActive) {
                    showWarningModal();
                }
            }, 100); // Reduced delay for faster detection
        }
    });

    // Window focus monitoring
    let focusTimeout;
    window.addEventListener('blur', function() {
        if (isExamActive && fullscreenInitialized) {
            focusTimeout = setTimeout(() => {
                showWarningModal();
            }, 500); // Reduced delay
        }
    });

    window.addEventListener('focus', function() {
        if (focusTimeout) clearTimeout(focusTimeout);
        if (isExamActive && fullscreenInitialized) {
            setTimeout(forceFullscreen, 200);
        }
    });

    // Continuous monitoring with higher frequency
    fullscreenCheckInterval = setInterval(() => {
        if (isExamActive && fullscreenInitialized && !isInFullscreen()) {
            enforceFullscreen();
        }
    }, 1000); // Check every second

    // Prevent context menu
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        if (isExamActive) showWarningModal();
        return false;
    });

    // Prevent text selection except form elements
    document.addEventListener('selectstart', function(e) {
        const allowedElements = ['INPUT', 'TEXTAREA'];
        const allowedClasses = ['form-check-label'];

        if (!allowedElements.includes(e.target.tagName) &&
            !allowedClasses.some(cls => e.target.classList.contains(cls))) {
            e.preventDefault();
            return false;
        }
    });

    // Prevent drag operations
    document.addEventListener('dragstart', function(e) {
        e.preventDefault();
        return false;
    });

    // Mouse leave detection
    document.addEventListener('mouseleave', function(e) {
        if (isExamActive && fullscreenInitialized && e.clientY <= 0) {
            setTimeout(() => {
                if (isExamActive) showWarningModal();
            }, 1000);
        }
    });

    // Disable F11 specifically for fullscreen toggle prevention
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F11') {
            e.preventDefault();
            e.stopImmediatePropagation();
            showWarningModal();
            return false;
        }
    }, true);
}

/**
 * Comprehensive key blocking function
 */
function blockAllDangerousKeys(e) {
    if (!isExamActive || !examStarted) return;

    // Blocked individual keys
    const blockedKeys = [
        'F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12',
        'Escape', 'PrintScreen', 'Insert', 'Delete', 'Home', 'End', 'PageUp', 'PageDown'
    ];

    // Blocked key combinations
    const blockedCombinations = [
        // Developer tools and debugging
        { ctrl: true, shift: true, key: 'I' }, // Dev tools
        { ctrl: true, shift: true, key: 'J' }, // Console
        { ctrl: true, shift: true, key: 'C' }, // Inspector
        { ctrl: true, key: 'U' }, // View source
        { key: 'F12' }, // Dev tools

        // Browser functions
        { ctrl: true, key: 'R' }, // Refresh
        { ctrl: true, key: 'F5' }, // Hard refresh
        { ctrl: true, shift: true, key: 'R' }, // Hard refresh
        { ctrl: true, key: 'W' }, // Close tab
        { ctrl: true, shift: true, key: 'W' }, // Close window
        { ctrl: true, key: 'T' }, // New tab
        { ctrl: true, key: 'N' }, // New window
        { ctrl: true, shift: true, key: 'N' }, // Incognito

        // Navigation and history
        { alt: true, key: 'ArrowLeft' }, // Back
        { alt: true, key: 'ArrowRight' }, // Forward
        { ctrl: true, key: 'H' }, // History
        { ctrl: true, shift: true, key: 'Delete' }, // Clear data

        // System shortcuts
        { alt: true, key: 'F4' }, // Close application
        { alt: true, key: 'Tab' }, // Switch application
        { ctrl: true, key: 'Tab' }, // Switch tab
        { ctrl: true, shift: true, key: 'Tab' }, // Switch tab reverse
        { meta: true, key: 'Tab' }, // Mac app switch
        { meta: true, key: '`' }, // Mac window switch
        { meta: true, key: 'M' }, // Mac minimize
        { meta: true, key: 'H' }, // Mac hide
        { meta: true, key: 'Q' }, // Mac quit
        { ctrl: true, shift: true, key: 'Q' }, // Quit

        // Clipboard operations
        { ctrl: true, key: 'A' }, // Select all
        { ctrl: true, key: 'C' }, // Copy
        { ctrl: true, key: 'V' }, // Paste
        { ctrl: true, key: 'X' }, // Cut
        { ctrl: true, key: 'Z' }, // Undo
        { ctrl: true, key: 'Y' }, // Redo

        // Save and print
        { ctrl: true, key: 'S' }, // Save
        { ctrl: true, key: 'P' }, // Print
        { ctrl: true, shift: true, key: 'S' }, // Save as

        // Find and search
        { ctrl: true, key: 'F' }, // Find
        { ctrl: true, key: 'G' }, // Find next
        { ctrl: true, shift: true, key: 'G' }, // Find previous
        { ctrl: true, key: 'K' }, // Search
        { ctrl: true, key: 'L' }, // Address bar

        // Zoom
        { ctrl: true, key: '=' }, // Zoom in
        { ctrl: true, key: '-' }, // Zoom out
        { ctrl: true, key: '0' }, // Reset zoom
    ];

    // Check individual blocked keys
    if (blockedKeys.includes(e.key)) {
        e.preventDefault();
        e.stopImmediatePropagation();
        showWarningModal();
        return false;
    }

    // Check blocked combinations
    for (let combo of blockedCombinations) {
        let matches = true;

        if (combo.ctrl !== undefined && combo.ctrl !== e.ctrlKey) matches = false;
        if (combo.shift !== undefined && combo.shift !== e.shiftKey) matches = false;
        if (combo.alt !== undefined && combo.alt !== e.altKey) matches = false;
        if (combo.meta !== undefined && combo.meta !== e.metaKey) matches = false;

        if (matches && combo.key === e.key) {
            e.preventDefault();
            e.stopImmediatePropagation();
            showWarningModal();
            return false;
        }
    }
}

/**
 * Shows warning modal with enhanced enforcement
 */
function showWarningModal() {
    if (!isExamActive || !examStarted || window.warningModalVisible) return;

    warningCount++;
    document.getElementById('warningCount').textContent = warningCount;

    const modal = document.getElementById('warningModal');
    modal.style.display = 'flex';
    window.warningModalVisible = true;

    // Pause timer while warning is shown
    if (timerInterval) {
        clearInterval(timerInterval);
    }

    // Force focus on modal
    setTimeout(() => {
        const returnBtn = modal.querySelector('.btn');
        if (returnBtn) returnBtn.focus();
    }, 100);

    // Auto-submit after maximum warnings
    if (warningCount >= MAX_WARNINGS) {
        setTimeout(() => {
            isExamActive = false;
            cleanupFullscreenProtection();
            alert("Maximum violations reached. Exam will be submitted automatically.");
            document.querySelector('button[name="submit_exam"]').click();
        }, 2000);
    }
}

/**
 * Close warning modal and re-enforce fullscreen
 */
function closeWarningModal() {
    document.getElementById('warningModal').style.display = 'none';
    window.warningModalVisible = false;

    // Only continue if we haven't reached max warnings
    if (warningCount < MAX_WARNINGS) {
        isExamActive = true;
        examStarted = true;
        
        // Resume timer
        if (!timerInterval) {
            timerInterval = setInterval(updateTimer, 1000);
        }

        // Immediate fullscreen attempt
        forceFullscreen();
        
        // Additional fullscreen attempts with delays
        setTimeout(() => {
            if (!isInFullscreen()) forceFullscreen();
        }, 500);
        
        setTimeout(() => {
            if (!isInFullscreen()) forceFullscreen();
        }, 1500);
    }
}

/**
 * Question navigation functions
 */
function showQuestion(questionNumber) {
    const questions = document.querySelectorAll('.question-container');
    questions.forEach(q => q.style.display = 'none');

    document.getElementById(`question${questionNumber}`).style.display = 'block';
    document.getElementById('currentQuestion').textContent = questionNumber;

    updateNavigationButtons(questionNumber, questions.length);

    const buttons = document.querySelectorAll('.question-btn');
    buttons.forEach(btn => btn.classList.remove('current'));
    document.getElementById(`questionBtn${questionNumber}`).classList.add('current');

    window.scrollTo(0, 0);
}

function updateNavigationButtons(currentQuestionNumber, totalQuestions) {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    prevBtn.disabled = currentQuestionNumber === 1;
    prevBtn.classList.toggle('disabled', currentQuestionNumber === 1);

    if (currentQuestionNumber === totalQuestions) {
        nextBtn.innerHTML = 'Submit Exam <i class="fas fa-paper-plane ms-1"></i>';
        nextBtn.classList.remove('btn-outline-primary');
        nextBtn.classList.add('btn-primary');
        nextBtn.onclick = () => {
            if (confirmSubmit()) {
                cleanupFullscreenProtection();
                document.getElementById('examForm').submit();
            }
        };
    } else {
        nextBtn.innerHTML = 'Next <i class="fas fa-arrow-right ms-1"></i>';
        nextBtn.classList.remove('btn-primary');
        nextBtn.classList.add('btn-outline-primary');
        nextBtn.onclick = navigateToNext;
    }
}

function navigateToPrevious() {
    const currentQuestion = parseInt(document.getElementById('currentQuestion').textContent);
    if (currentQuestion > 1) {
        showQuestion(currentQuestion - 1);
    }
}

function navigateToNext() {
    const currentQuestion = parseInt(document.getElementById('currentQuestion').textContent);
    const totalQuestions = document.querySelectorAll('.question-container').length;
    if (currentQuestion < totalQuestions) {
        showQuestion(currentQuestion + 1);
    }
}

function updateAnswerStatus(questionId, questionNumber) {
    const statusBadge = document.getElementById(`status_${questionId}`);
    statusBadge.innerHTML = '<i class="fas fa-check me-1"></i> Answered';
    statusBadge.classList.remove('bg-secondary');
    statusBadge.classList.add('bg-success');

    const sidebarBtn = document.getElementById(`questionBtn${questionNumber}`);
    sidebarBtn.classList.add('answered');

    const selectedOption = document.querySelector(`input[name="answer_${questionId}"]:checked`);
    if (selectedOption) {
        const allOptions = document.querySelectorAll(`input[name="answer_${questionId}"]`);
        allOptions.forEach(option => {
            option.closest('.form-check').classList.remove('selected');
        });
        selectedOption.closest('.form-check').classList.add('selected');
    }

    updateAnsweredCount();
}

function updateAnsweredCount() {
    const answeredQuestions = document.querySelectorAll('.question-btn.answered').length;
    document.getElementById('answeredCount').textContent = answeredQuestions;
}

function setupAnswerDetection() {
    const radioButtons = document.querySelectorAll('input[type="radio"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            const questionId = this.name.replace('answer_', '');
            const questionNumber = Array.from(document.querySelectorAll('.question-container'))
                .findIndex(q => q.querySelector(`input[name="answer_${questionId}"]`)) + 1;
            updateAnswerStatus(questionId, questionNumber);
        });
    });
}

function setupSubmitButtons() {
    const submitButtons = document.querySelectorAll('button[name="submit_exam"]');
    submitButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            if (confirmSubmit()) {
                cleanupFullscreenProtection();
            } else {
                e.preventDefault();
            }
        });
    });
}

function handleFinalSubmit(isAutoSubmit = false) {
    const answeredQuestions = document.querySelectorAll('.question-btn.answered').length;
    const totalQuestions = document.querySelectorAll('.question-container').length;

    // For automatic submission due to time's up
    if (isAutoSubmit) {
        cleanupFullscreenProtection();
        const form = document.getElementById('examForm');
        form.action = form.action + '?final_submit=true&auto_submit=true';
        form.submit();
        return false; // Prevent default form submission
    }

    // For manual submission
    if (answeredQuestions < totalQuestions) {
        if (!confirm(`You have only answered ${answeredQuestions} out of ${totalQuestions} questions. Are you sure you want to submit your exam?`)) {
            return false;
        }
    } else if (!confirm("Are you sure you want to submit your exam? Once submitted, you cannot make changes.")) {
        return false;
    }

    // Clean up and submit
    cleanupFullscreenProtection();
    
    // Redirect to dashboard after submission
    const form = document.getElementById('examForm');
    form.action = form.action + '?final_submit=true';
    return true;
}

function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
}

function updateTimer() {
    if (timeRemaining <= 0) {
        clearInterval(timerInterval);
        
        // Show a warning dialog with a countdown before submission
        if (confirm("Time's up! Click OK to submit your exam or Cancel to review your answers for 2 more minutes.")) {
            handleFinalSubmit(true); // true indicates it's an automatic submission
        } else {
            // Give 2 more minutes for review
            timeRemaining = 120;
            timerInterval = setInterval(updateTimer, 1000);
            document.getElementById('timerContainer').classList.add('low-time');
        }
        return;
    }

    timeRemaining--;
    document.getElementById('timer').textContent = formatTime(timeRemaining);

    // Show warning at 5 minutes remaining
    if (timeRemaining === 300) {
        alert("5 minutes remaining! Please start reviewing your answers.");
        document.getElementById('timerContainer').classList.add('low-time');
    }
    
    // Show warning at 1 minute remaining
    if (timeRemaining === 60) {
        alert("1 minute remaining! Please prepare to submit your exam.");
    }
}

function cleanupFullscreenProtection() {
    isExamActive = false;
    examStarted = false;
    fullscreenInitialized = false;

    if (fullscreenCheckInterval) {
        clearInterval(fullscreenCheckInterval);
    }

    if (timerInterval) {
        clearInterval(timerInterval);
    }

    document.body.classList.remove('exam-mode');
    document.getElementById('fullscreenLock').classList.remove('active');

    // Exit fullscreen
    try {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    } catch (e) {
        console.log('Error exiting fullscreen:', e);
    }
}

// Page protection events
window.addEventListener('beforeunload', function(e) {
    if (isExamActive && examStarted) {
        const message = 'Are you sure you want to leave the exam? Your progress may be lost.';
        e.preventDefault();
        e.returnValue = message;
        return message;
    }
});

window.addEventListener('beforeprint', function(e) {
    e.preventDefault();
    if (isExamActive && examStarted) {
        showWarningModal();
    }
    return false;
});

window.addEventListener('popstate', function(e) {
    if (isExamActive && examStarted) {
        showWarningModal();
        history.pushState(null, null, location.href);
    }
});

// Initialize page protection
history.pushState(null, null, location.href);

// Prevent any console access
console.log = console.warn = console.error = console.info = console.debug = function() {};

// Override common developer shortcuts
Object.defineProperty(window, 'console', {
    get: function() {
        if (isExamActive) {
            showWarningModal();
        }
        return {};
    }
});

// Disable right-click completely
document.addEventListener('contextmenu', e => e.preventDefault());

// Additional protection against common cheating methods
document.addEventListener('copy', e => { if (isExamActive) e.preventDefault(); });
document.addEventListener('paste', e => { if (isExamActive) e.preventDefault(); });
document.addEventListener('cut', e => { if (isExamActive) e.preventDefault(); });
</script>
</body>
</html>