{% extends 'base.html' %}

{% block title %}Super Admin Dashboard - Emerging India Analytics{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<style>
    .sidebar {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .sidebar .list-group-item {
        border: none;
        padding: 12px 20px;
        transition: all 0.3s ease;
    }

    .sidebar .list-group-item:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
    }

    .sidebar .list-group-item.active {
        background-color: var(--primary-color);
        color: white;
    }

    .stat-card {
        border-radius: 10px;
        overflow: hidden;
        border: none;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .stat-card .card-body {
        padding: 20px;
    }
    .chart-container {
        position: relative;
        height: 300px;  /* Increased height for better visibility */
        width: 100%;
        margin-bottom: 20px;
    }

    /* Ensure canvas fills the container */
    .chart-container canvas {
        height: 100% !important;
        width: 100% !important;
    }
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0;
    }

    .stat-label {
        color: #e9ecef;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .chart-container {
        position: relative;
        height: 250px;
        margin-bottom: 20px;
    }

    .data-table th {
        background-color: var(--primary-color);
        color: white;
    }

    .user-avatar {
        width: 120px;
        height: 120px;
        margin: 0 auto 15px;
    }

    .avatar-svg {
        width: 100%;
        height: 100%;
    }

    .badge-role {
        font-size: 0.8rem;
        padding: 5px 10px;
        border-radius: 20px;
    }

    .badge-super-admin {
        background-color: var(--primary-color);
    }

    .table-hover tbody tr:hover {
        background-color: rgba(166, 34, 60, 0.05);
    }

    .dashboard-header {
        background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .refresh-stats {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Navbar modifications for super admin -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add Super Admin nav items to the navbar
    const navbarNav = document.querySelector('#navbarNav .navbar-nav');

    // Check if navbar exists and user is authenticated
    if (navbarNav) {
        // Clear existing nav items
        navbarNav.innerHTML = `
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="/">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/super-admin/dashboard' %}active{% endif %}" href="{{ url_for('super_admin_dashboard') }}">Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/super-admin/users' %}active{% endif %}" href="{{ url_for('manage_users') }}">Manage Users</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#reportsModal">Reports</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </li>
        `;
    }
});
</script>

<div class="container-fluid mt-4">
    <div class="row">
        <!-- Sidebar - Left column (3/12 width) -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body text-center">
                    <div class="user-avatar">
                        {% if current_user.avatar %}
                            {{ avatar_svg(current_user.avatar)|safe }}
                        {% else %}
                            <i class="bi bi-person-circle" style="font-size: 4rem; color: var(--primary-color);"></i>
                        {% endif %}
                    </div>
                    <h5 class="card-title">{{ current_user.email }}</h5>
                    <p class="card-text">
                        <span class="badge badge-role badge-super-admin">Super Administrator</span>
                    </p>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                            <i class="bi bi-box-arrow-right me-2"></i>Logout
                        </a>
                    </div>
                </div>
            </div>

            <div class="sidebar mb-4">
                <div class="list-group shadow-sm">
                    <a href="{{ url_for('super_admin_dashboard') }}" class="list-group-item list-group-item-action active">
                        <i class="bi bi-speedometer2 me-2"></i> Dashboard
                    </a>
                    <a href="{{ url_for('manage_users') }}" class="list-group-item list-group-item-action">
                        <i class="bi bi-people-fill me-2"></i> Manage Users
                    </a>
                    <a href="#reportsModal" data-bs-toggle="modal" class="list-group-item list-group-item-action">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i> Generate Reports
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content - Right column (9/12 width) -->
        <div class="col-md-9">
            <!-- Dashboard Header -->
            <div class="dashboard-header shadow-sm mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-0"><i class="bi bi-grid-1x2 me-2"></i>Super Admin Dashboard</h2>
                        <p class="mb-0">Welcome to the comprehensive admin control panel</p>
                    </div>
                    <button class="btn btn-light" id="refreshStats">
                        <i class="bi bi-arrow-repeat"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Stats Overview - First row -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card stat-card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="stat-number">{{ user_stats.total_users }}</h3>
                                    <p class="stat-label mb-0">Total Users</p>
                                </div>
                                <i class="bi bi-people-fill" style="font-size: 2.5rem; opacity: 0.5;"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="stat-number">{{ user_stats.students }}</h3>
                                    <p class="stat-label mb-0">Students</p>
                                </div>
                                <i class="bi bi-mortarboard-fill" style="font-size: 2.5rem; opacity: 0.5;"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="stat-number">{{ user_stats.admins }}</h3>
                                    <p class="stat-label mb-0">Admins</p>
                                </div>
                                <i class="bi bi-person-badge-fill" style="font-size: 2.5rem; opacity: 0.5;"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="stat-number">{{ exam_stats.total_exams }}</h3>
                                    <p class="stat-label mb-0">Total Exams</p>
                                </div>
                                <i class="bi bi-file-text-fill" style="font-size: 2.5rem; opacity: 0.5;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section - Charts -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Platform Analytics</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="chart-container">
                                        <canvas id="userRoleChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="chart-container">
                                        <canvas id="streamDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="chart-container">
                                        <canvas id="examStatusChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="chart-container">
                                        <canvas id="userVerificationChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Exams Table -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Recent Exams</h5>
                            <span class="badge bg-light text-danger">{{ exams|length }} Total</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Created By</th>
                                            <th>Duration</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Students</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for exam in exams[:5] %}
                                        <tr>
                                            <td>{{ exam.title }}</td>
                                            <td>
                                                {% set creator = users|selectattr('id', 'equalto', exam.created_by)|first %}
                                                {{ creator.email if creator else 'Unknown' }}
                                            </td>
                                            <td>{{ exam.duration }} mins</td>
                                            <td>
                                                {% if exam.is_active %}
                                                    <span class="badge bg-success">Active</span>
                                                {% elif exam.end_time %}
                                                    <span class="badge bg-secondary">Completed</span>
                                                {% else %}
                                                    <span class="badge bg-warning text-dark">Not Started</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ exam.created_at.strftime('%Y-%m-%d') }}</td>
                                            <td>
                                                {% set student_count = exam.student_exams|length %}
                                                <span class="badge bg-info">{{ student_count }}</span>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" onclick="viewExamDetails({{ exam.id }})" title="View Details">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="7" class="text-center">No exams available</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if exams|length > 5 %}
                            <div class="text-center mt-3">
                                <button class="btn btn-outline-primary btn-sm" id="viewAllExams">View All Exams</button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Users Table -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-people me-2"></i>Recent Users</h5>
                            <a href="{{ url_for('manage_users') }}" class="btn btn-sm btn-light">
                                <i class="bi bi-person-plus-fill"></i> Manage Users
                            </a>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Verified</th>
                                            <th>Stream</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in users[:5] %}
                                        <tr>
                                            <td>{{ user.name or 'Not Set' }}</td>
                                            <td>{{ user.email }}</td>
                                            <td>
                                                {% if user.role == 'super_admin' %}
                                                <span class="badge bg-danger">Super Admin</span>
                                                {% elif user.role == 'admin' %}
                                                <span class="badge bg-primary">Admin</span>
                                                {% else %}
                                                <span class="badge bg-success">Student</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if user.is_verified %}
                                                <span class="badge bg-success">Yes</span>
                                                {% else %}
                                                <span class="badge bg-warning text-dark">No</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ user.stream or 'Not Set' }}</td>
                                            <td>
                                                <div class="btn-group">
                                                    <a href="{{ url_for('edit_user', user_id=user.id) }}" class="btn btn-sm btn-outline-primary" title="Edit User">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>

                                                    {% if user.role == 'student' %}
                                                    <button class="btn btn-sm btn-outline-info" onclick="promoteUser({{ user.id }})" title="Promote to Admin">
                                                        <i class="bi bi-arrow-up-circle"></i>
                                                    </button>
                                                    {% elif user.role == 'admin' %}
                                                    <button class="btn btn-sm btn-outline-warning" onclick="demoteUser({{ user.id }})" title="Demote to Student">
                                                        <i class="bi bi-arrow-down-circle"></i>
                                                    </button>
                                                    {% endif %}

                                                    {% if user.id != current_user.id and user.role != 'super_admin' %}
                                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ user.id }})" title="Delete User">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="6" class="text-center">No users available</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reports Modal -->
<div class="modal fade" id="reportsModal" tabindex="-1" aria-labelledby="reportsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="reportsModalLabel"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Generate Reports</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('generate_report') }}" method="post">
                    <div class="mb-3">
                        <label for="report_type" class="form-label">Report Type</label>
                        <select class="form-select" id="report_type" name="report_type" required>
                            <option value="" selected disabled>Select a report type</option>
                            <option value="users">User Management Report</option>
                            <option value="exams">Exam Report</option>
                            <option value="students">Student Performance Report</option>
                            <option value="proctoring">Proctoring Events Report</option>
                        </select>
                    </div>

                    <!-- Dynamic fields based on report type -->
                    <div id="exam-fields" class="d-none">
                        <div class="mb-3">
                            <label for="exam_id" class="form-label">Select Exam (optional)</label>
                            <select class="form-select" id="exam_id" name="exam_id">
                                <option value="">All Exams</option>
                                {% for exam in exams %}
                                <option value="{{ exam.id }}">{{ exam.title }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Leave blank to generate a report for all exams</div>
                        </div>
                    </div>

                    <div id="student-fields" class="d-none">
                        <div class="mb-3">
                            <label for="student_search" class="form-label">Student Search (optional)</label>
                            <input type="text" class="form-control" id="student_search" name="student_search" placeholder="Name or email">
                        </div>
                        <div class="mb-3">
                            <label for="stream" class="form-label">Stream (optional)</label>
                            <select class="form-select" id="stream" name="stream">
                                <option value="">All Streams</option>
                                {% for stream, count in stream_data.items() %}
                                <option value="{{ stream }}">{{ stream }} ({{ count }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div id="user-fields" class="d-none">
                        <div class="mb-3">
                            <label for="role_filter" class="form-label">User Role</label>
                            <select class="form-select" id="role_filter" name="role_filter">
                                <option value="all">All Roles</option>
                                <option value="student">Students</option>
                                <option value="admin">Admins</option>
                                <option value="super_admin">Super Admins</option>
                            </select>
                        </div>
                    </div>

                    <div id="proctoring-fields" class="d-none">
                        <div class="mb-3">
                            <label class="form-label">Event Types</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="event_types" value="tab_switch" id="tab_switch" checked>
                                <label class="form-check-label" for="tab_switch">Tab Switches</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="event_types" value="fullscreen_exit" id="fullscreen_exit" checked>
                                <label class="form-check-label" for="fullscreen_exit">Fullscreen Exits</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="event_types" value="copy_attempt" id="copy_attempt" checked>
                                <label class="form-check-label" for="copy_attempt">Copy Attempts</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="event_types" value="paste_attempt" id="paste_attempt" checked>
                                <label class="form-check-label" for="paste_attempt">Paste Attempts</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="event_types" value="mouse_leave" id="mouse_leave" checked>
                                <label class="form-check-label" for="mouse_leave">Mouse Leave Events</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="event_types" value="periodic_screenshot" id="periodic_screenshot" checked>
                                <label class="form-check-label" for="periodic_screenshot">Periodic Screenshots</label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="report_format" class="form-label">Report Format</label>
                        <select class="form-select" id="report_format" name="report_format">
                            <option value="excel" selected>Excel (.xlsx)</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-danger">Generate Report</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addUserModalLabel"><i class="bi bi-person-plus-fill me-2"></i>Add New User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm" method="post" action="/super-admin/add-user">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" name="name">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password *</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Role *</label>
                        <select class="form-select" id="role" name="role" required>
                            <option value="student">Student</option>
                            <option value="admin">Administrator</option>
                            <option value="super_admin">Super Administrator</option>
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="1" id="is_verified" name="is_verified" checked>
                        <label class="form-check-label" for="is_verified">
                            Account Verified
                        </label>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                Are you sure you want to proceed with this action?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Navbar modification for super admin
document.addEventListener('DOMContentLoaded', function() {
    // Add Super Admin nav items to the navbar
    const navbarNav = document.querySelector('#navbarNav .navbar-nav');

    // Check if navbar exists and user is authenticated
    if (navbarNav) {
        // Clear existing nav items
        navbarNav.innerHTML = `
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="/">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/super-admin/dashboard' %}active{% endif %}" href="{{ url_for('super_admin_dashboard') }}">Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/super-admin/users' %}active{% endif %}" href="{{ url_for('manage_users') }}">Manage Users</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#reportsModal">Reports</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </li>
        `;
    }
});

// DOM content loaded event handler for the dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Show/hide dynamic form fields based on selected report type
    const reportTypeSelect = document.getElementById('report_type');
    if (reportTypeSelect) {
        reportTypeSelect.addEventListener('change', function() {
            // Hide all conditional fields first
            document.getElementById('exam-fields').classList.add('d-none');
            document.getElementById('student-fields').classList.add('d-none');
            document.getElementById('user-fields').classList.add('d-none');
            document.getElementById('proctoring-fields').classList.add('d-none');

            // Show relevant fields based on selection
            const selectedType = this.value;
            if (selectedType === 'exams') {
                document.getElementById('exam-fields').classList.remove('d-none');
            } else if (selectedType === 'students') {
                document.getElementById('exam-fields').classList.remove('d-none');
                document.getElementById('student-fields').classList.remove('d-none');
            } else if (selectedType === 'users') {
                document.getElementById('user-fields').classList.remove('d-none');
            } else if (selectedType === 'proctoring') {
                document.getElementById('exam-fields').classList.remove('d-none');
                document.getElementById('proctoring-fields').classList.remove('d-none');
            }
        });
    }

    // Add animation to refresh button
    const refreshBtn = document.getElementById('refreshStats');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            const icon = this.querySelector('i');
            icon.classList.add('refresh-stats');

            // Simulate loading and refresh charts
            setTimeout(() => {
                icon.classList.remove('refresh-stats');
                loadChartData();
            }, 1000);

            // Optional: Refresh page data
            // window.location.reload();
        });
    }

    // Manage Users Button
    const manageUsersBtn = document.querySelector('.btn-light[href*="manage_users"]');
    if (manageUsersBtn) {
        manageUsersBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = "{{ url_for('manage_users') }}";
        });
    }

    // View All Exams button
    const viewAllExamsBtn = document.getElementById('viewAllExams');
    if (viewAllExamsBtn) {
        viewAllExamsBtn.addEventListener('click', function() {
            // You can create a dedicated page for all exams or add functionality here
            alert('Implement view all exams functionality');
        });
    }

    // Load chart data on page load
    loadChartData();
});

// Function to load chart data from the API
function loadChartData() {
    fetch('/super-admin/api/user-stats')
        .then(response => response.json())
        .then(data => {
            createUserRoleChart(data.roles);
            createStreamDistributionChart(data.streams);
            createExamStatusChart(data.exams);
            createUserVerificationChart(data.verification);
        })
        .catch(error => console.error('Error loading chart data:', error));
}

// Create User Role Distribution Chart
function createUserRoleChart(roleData) {
    const ctx = document.getElementById('userRoleChart').getContext('2d');
    if (window.userRoleChart) {
        window.userRoleChart.destroy();
    }

    window.userRoleChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(roleData).map(role => role === 'super_admin' ? 'Super Admin' :
                                            (role === 'admin' ? 'Admin' : 'Student')),
            datasets: [{
                data: Object.values(roleData),
                backgroundColor: [
                    '#dc3545',  // Red for Super Admin
                    '#0d6efd',  // Blue for Admin
                    '#20c997',  // Teal for Student
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'User Role Distribution'
                }
            }
        }
    });
}

// Create Stream Distribution Chart
function createStreamDistributionChart(streamData) {
    const labels = Object.keys(streamData);
    const data = Object.values(streamData);
    const backgroundColors = generateColors(labels.length);

    const ctx = document.getElementById('streamDistributionChart').getContext('2d');
    if (window.streamChart) {
        window.streamChart.destroy();
    }

    window.streamChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Students',
                data: data,
                backgroundColor: backgroundColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Stream Distribution'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

// Create Exam Status Chart
function createExamStatusChart(examData) {
    const ctx = document.getElementById('examStatusChart').getContext('2d');
    if (window.examChart) {
        window.examChart.destroy();
    }

    window.examChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(examData),
            datasets: [{
                data: Object.values(examData),
                backgroundColor: [
                    '#20c997',  // Active
                    '#6c757d',  // Completed
                    '#ffc107',  // Not Started
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'Exam Status'
                }
            }
        }
    });
}

// Create User Verification Chart
function createUserVerificationChart(verificationData) {
    const ctx = document.getElementById('userVerificationChart').getContext('2d');
    if (window.verificationChart) {
        window.verificationChart.destroy();
    }

    window.verificationChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(verificationData),
            datasets: [{
                data: Object.values(verificationData),
                backgroundColor: [
                    '#20c997',  // Verified
                    '#ffc107',  // Unverified
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'User Verification Status'
                }
            }
        }
    });
}

// Helper function to generate random colors for charts
function generateColors(count) {
    const baseColors = [
        '#0d6efd', '#20c997', '#fd7e14', '#dc3545', '#6f42c1',
        '#0dcaf0', '#198754', '#ffc107', '#6c757d', '#d63384'
    ];

    let colors = [];
    for (let i = 0; i < count; i++) {
        colors.push(baseColors[i % baseColors.length]);
    }
    return colors;
}

// Function to view exam details
function viewExamDetails(examId) {
    // You can implement a modal or redirect to a detailed exam view page
    alert(`Viewing details for exam ID: ${examId}`);
}

// Function to show confirmation modal
function showConfirmModal(message, callback) {
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    document.getElementById('confirmModalBody').textContent = message;
    document.getElementById('confirmActionBtn').onclick = function() {
        callback();
        modal.hide();
    };
    modal.show();
}

// Function to promote user to admin
function promoteUser(userId) {
    showConfirmModal('Are you sure you want to promote this user to admin?', function() {
        fetch(`/super-admin/user/${userId}/promote`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User promoted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your request.');
        });
    });
}

// Function to demote user to student
function demoteUser(userId) {
    showConfirmModal('Are you sure you want to demote this user to student?', function() {
        fetch(`/super-admin/user/${userId}/demote`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User demoted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your request.');
        });
    });
}

// Function to delete user
function deleteUser(userId) {
    showConfirmModal('Are you sure you want to delete this user? This action cannot be undone.', function() {
        fetch(`/super-admin/user/${userId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User deleted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your request.');
        });
    });
}
// Navbar modification for super admin
document.addEventListener('DOMContentLoaded', function() {
    // Add Super Admin nav items to the navbar
    const navbarNav = document.querySelector('#navbarNav .navbar-nav');

    // Check if navbar exists and user is authenticated
    if (navbarNav) {
        // Clear existing nav items
        navbarNav.innerHTML = `
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="/">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/super-admin/dashboard' %}active{% endif %}" href="{{ url_for('super_admin_dashboard') }}">Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/super-admin/users' %}active{% endif %}" href="{{ url_for('manage_users') }}">Manage Users</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#reportsModal">Reports</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </li>
        `;
    }
});

// DOM content loaded event handler for the dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Show/hide dynamic form fields based on selected report type
    const reportTypeSelect = document.getElementById('report_type');
    if (reportTypeSelect) {
        reportTypeSelect.addEventListener('change', function() {
            // Hide all conditional fields first
            document.getElementById('exam-fields').classList.add('d-none');
            document.getElementById('student-fields').classList.add('d-none');
            document.getElementById('user-fields').classList.add('d-none');
            document.getElementById('proctoring-fields').classList.add('d-none');

            // Show relevant fields based on selection
            const selectedType = this.value;
            if (selectedType === 'exams') {
                document.getElementById('exam-fields').classList.remove('d-none');
            } else if (selectedType === 'students') {
                document.getElementById('exam-fields').classList.remove('d-none');
                document.getElementById('student-fields').classList.remove('d-none');
            } else if (selectedType === 'users') {
                document.getElementById('user-fields').classList.remove('d-none');
            } else if (selectedType === 'proctoring') {
                document.getElementById('exam-fields').classList.remove('d-none');
                document.getElementById('proctoring-fields').classList.remove('d-none');
            }
        });
    }

    // Add animation to refresh button
    const refreshBtn = document.getElementById('refreshStats');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            const icon = this.querySelector('i');
            icon.classList.add('refresh-stats');

            // Simulate loading and refresh charts
            setTimeout(() => {
                icon.classList.remove('refresh-stats');
                loadChartData();
            }, 1000);

            // Optional: Refresh page data
            // window.location.reload();
        });
    }

    // Manage Users Button
    const manageUsersBtn = document.querySelector('.btn-light[href*="manage_users"]');
    if (manageUsersBtn) {
        manageUsersBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = "{{ url_for('manage_users') }}";
        });
    }

    // View All Exams button
    const viewAllExamsBtn = document.getElementById('viewAllExams');
    if (viewAllExamsBtn) {
        viewAllExamsBtn.addEventListener('click', function() {
            // You can create a dedicated page for all exams or add functionality here
            alert('Implement view all exams functionality');
        });
    }

    // Load chart data on page load
    loadChartData();
});

// Function to load chart data from the API
function loadChartData() {
    fetch('/super-admin/api/user-stats')
        .then(response => response.json())
        .then(data => {
            createUserRoleChart(data.roles);
            createStreamDistributionChart(data.streams);
            createExamStatusChart(data.exams);
            createUserVerificationChart(data.verification);
        })
        .catch(error => console.error('Error loading chart data:', error));
}

// Create User Role Distribution Chart
function createUserRoleChart(roleData) {
    const ctx = document.getElementById('userRoleChart').getContext('2d');
    if (window.userRoleChart) {
        window.userRoleChart.destroy();
    }

    window.userRoleChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(roleData).map(role => role === 'super_admin' ? 'Super Admin' :
                                            (role === 'admin' ? 'Admin' : 'Student')),
            datasets: [{
                data: Object.values(roleData),
                backgroundColor: [
                    '#dc3545',  // Red for Super Admin
                    '#0d6efd',  // Blue for Admin
                    '#20c997',  // Teal for Student
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'User Role Distribution'
                }
            }
        }
    });
}

// Create Stream Distribution Chart
function createStreamDistributionChart(streamData) {
    const labels = Object.keys(streamData);
    const data = Object.values(streamData);
    const backgroundColors = generateColors(labels.length);

    const ctx = document.getElementById('streamDistributionChart').getContext('2d');
    if (window.streamChart) {
        window.streamChart.destroy();
    }

    window.streamChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Students',
                data: data,
                backgroundColor: backgroundColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Stream Distribution'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

// Create Exam Status Chart
function createExamStatusChart(examData) {
    const ctx = document.getElementById('examStatusChart').getContext('2d');
    if (window.examChart) {
        window.examChart.destroy();
    }

    window.examChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(examData),
            datasets: [{
                data: Object.values(examData),
                backgroundColor: [
                    '#20c997',  // Active
                    '#6c757d',  // Completed
                    '#ffc107',  // Not Started
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'Exam Status'
                }
            }
        }
    });
}

// Create User Verification Chart
function createUserVerificationChart(verificationData) {
    const ctx = document.getElementById('userVerificationChart').getContext('2d');
    if (window.verificationChart) {
        window.verificationChart.destroy();
    }

    window.verificationChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(verificationData),
            datasets: [{
                data: Object.values(verificationData),
                backgroundColor: [
                    '#20c997',  // Verified
                    '#ffc107',  // Unverified
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'User Verification Status'
                }
            }
        }
    });
}

// Helper function to generate random colors for charts
function generateColors(count) {
    const baseColors = [
        '#0d6efd', '#20c997', '#fd7e14', '#dc3545', '#6f42c1',
        '#0dcaf0', '#198754', '#ffc107', '#6c757d', '#d63384'
    ];

    let colors = [];
    for (let i = 0; i < count; i++) {
        colors.push(baseColors[i % baseColors.length]);
    }
    return colors;
}

// Function to view exam details
function viewExamDetails(examId) {
    // You can implement a modal or redirect to a detailed exam view page
    alert(`Viewing details for exam ID: ${examId}`);
}

// Function to show confirmation modal
function showConfirmModal(message, callback) {
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    document.getElementById('confirmModalBody').textContent = message;
    document.getElementById('confirmActionBtn').onclick = function() {
        callback();
        modal.hide();
    };
    modal.show();
}

// Function to promote user to admin
function promoteUser(userId) {
    showConfirmModal('Are you sure you want to promote this user to admin?', function() {
        fetch(`/super-admin/user/${userId}/promote`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User promoted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your request.');
        });
    });
}

// Function to demote user to student
function demoteUser(userId) {
    showConfirmModal('Are you sure you want to demote this user to student?', function() {
        fetch(`/super-admin/user/${userId}/demote`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User demoted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your request.');
        });
    });
}

// Function to delete user
function deleteUser(userId) {
    showConfirmModal('Are you sure you want to delete this user? This action cannot be undone.', function() {
        fetch(`/super-admin/user/${userId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User deleted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your request.');
        });
    });
}

    // Function to view user details
function viewUserDetails(userId) {
    // Create a modal dynamically if it doesn't exist
    let modal = document.getElementById('userDetailsModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'userDetailsModal';
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">User Details</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="userDetailsModalBody">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Loading user details...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Initialize the modal using Bootstrap
        new bootstrap.Modal(modal);
    }

    // Show the modal
    const modalInstance = bootstrap.Modal.getInstance(modal);
    modalInstance.show();

    // Fetch user details
    fetch(`/super-admin/user/${userId}/details`)
        .then(response => response.json())
        .then(user => {
            // Generate detailed HTML for user details
            const modalBody = document.getElementById('userDetailsModalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <div class="user-avatar mb-3">
                            ${user.avatar ? `<img src="/static/uploads/${user.avatar}" class="img-fluid rounded-circle" alt="User Avatar">` : '<i class="bi bi-person-circle" style="font-size: 6rem; color: var(--primary-color);"></i>'}
                        </div>
                        <h4>${user.name}</h4>
                        <p class="text-muted">${user.email}</p>
                        <span class="badge ${user.role === 'super_admin' ? 'bg-danger' : (user.role === 'admin' ? 'bg-primary' : 'bg-success')}">
                            ${user.role.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                        </span>
                    </div>
                    <div class="col-md-8">
                        <h5 class="border-bottom pb-2 mb-3">User Information</h5>
                        <div class="row mb-2">
                            <div class="col-5 text-muted">Stream:</div>
                            <div class="col-7">${user.stream}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-5 text-muted">Contact:</div>
                            <div class="col-7">${user.contact}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-5 text-muted">Verified:</div>
                            <div class="col-7">
                                <span class="badge ${user.is_verified ? 'bg-success' : 'bg-warning'}">
                                    ${user.is_verified ? 'Yes' : 'No'}
                                </span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-5 text-muted">Registered:</div>
                            <div class="col-7">${user.created_at}</div>
                        </div>

                        <h5 class="border-bottom pb-2 mt-4 mb-3">Exam History</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Exam Title</th>
                                        <th>Score</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${user.exams_taken.length > 0
                                        ? user.exams_taken.map(exam => `
                                            <tr>
                                                <td>${exam.title}</td>
                                                <td>${exam.score ? exam.score.toFixed(2) + '%' : 'N/A'}</td>
                                                <td>${exam.date}</td>
                                                <td>
                                                    <span class="badge ${exam.is_completed ? 'bg-success' : 'bg-warning'}">
                                                        ${exam.is_completed ? 'Completed' : 'In Progress'}
                                                    </span>
                                                </td>
                                            </tr>
                                        `).join('')
                                        : `<tr><td colspan="4" class="text-center text-muted">No exams taken</td></tr>`
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error fetching user details:', error);
            const modalBody = document.getElementById('userDetailsModalBody');
            modalBody.innerHTML = `
                <div class="alert alert-danger text-center">
                    <p>Unable to load user details. Please try again later.</p>
                </div>
            `;
        });
}

// Function to promote user to admin
function promoteUser(userId) {
    showConfirmModal('Are you sure you want to promote this user to admin?', function() {
        fetch(`/super-admin/user/${userId}/promote`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                flash('User promoted successfully!', 'success');
                location.reload();
            } else {
                flash(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            flash('An error occurred while processing your request.', 'danger');
        });
    });
}

// Function to demote user to student
function demoteUser(userId) {
    showConfirmModal('Are you sure you want to demote this user to student?', function() {
        fetch(`/super-admin/user/${userId}/demote`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                flash('User demoted successfully!', 'success');
                location.reload();
            } else {
                flash(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            flash('An error occurred while processing your request.', 'danger');
        });
    });
}

// Function to delete user
function deleteUser(userId) {
    showConfirmModal('Are you sure you want to delete this user? This action cannot be undone.', function() {
        fetch(`/super-admin/user/${userId}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                flash('User deleted successfully!', 'success');
                location.reload();
            } else {
                flash(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            flash('An error occurred while processing your request.', 'danger');
        });
    });
}

// Add a flash function if not already defined
function flash(message, type = 'info') {
    const flashContainer = document.createElement('div');
    flashContainer.className = `alert alert-${type} alert-dismissible fade show fixed-top`;
    flashContainer.style.zIndex = '1050';
    flashContainer.style.top = '20px';
    flashContainer.style.left = '50%';
    flashContainer.style.transform = 'translateX(-50%)';

    flashContainer.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

    document.body.appendChild(flashContainer);

    // Remove the alert after 5 seconds
    setTimeout(() => {
        const alert = bootstrap.Alert.getInstance(flashContainer);
        if (alert) {
            alert.close();
        }
    }, 5000);
}

function loadChartData() {
    fetch('/super-admin/api/user-stats')
        .then(response => response.json())
        .then(data => {
            console.log('Chart data:', data); // Log the data for debugging
            createUserRoleChart(data.roles);
            createStreamDistributionChart(data.streams);
            createExamStatusChart(data.exams);
            createUserVerificationChart(data.verification);
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            // Optionally show an error message to the user
            alert('Failed to load chart data. Please refresh the page.');
        });
}

// Create User Role Distribution Chart
function createUserRoleChart(roleData) {
    const ctx = document.getElementById('userRoleChart').getContext('2d');

    // Destroy existing chart if it exists
    if (window.userRoleChart instanceof Chart) {
        window.userRoleChart.destroy();
    }

    // Normalize role names and handle potential undefined data
    const processedRoleData = {
        'Super Admin': roleData['super_admin'] || 0,
        'Admin': roleData['admin'] || 0,
        'Student': roleData['student'] || 0
    };

    window.userRoleChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(processedRoleData),
            datasets: [{
                data: Object.values(processedRoleData),
                backgroundColor: [
                    '#dc3545',  // Red for Super Admin
                    '#0d6efd',  // Blue for Admin
                    '#20c997',  // Teal for Student
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'User Role Distribution'
                }
            }
        }
    });
}

// Create Stream Distribution Chart
function createStreamDistributionChart(streamData) {
    const labels = Object.keys(streamData);
    const data = Object.values(streamData);
    const backgroundColors = generateColors(labels.length);

    const ctx = document.getElementById('streamDistributionChart').getContext('2d');

    // Destroy existing chart if it exists
    if (window.streamChart instanceof Chart) {
        window.streamChart.destroy();
    }

    window.streamChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Students',
                data: data,
                backgroundColor: backgroundColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Stream Distribution'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

// Create Exam Status Chart
function createExamStatusChart(examData) {
    const ctx = document.getElementById('examStatusChart').getContext('2d');

    // Destroy existing chart if it exists
    if (window.examChart instanceof Chart) {
        window.examChart.destroy();
    }

    window.examChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(examData),
            datasets: [{
                data: Object.values(examData),
                backgroundColor: [
                    '#20c997',  // Active
                    '#6c757d',  // Completed
                    '#ffc107',  // Not Started
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'Exam Status'
                }
            }
        }
    });
}

// Create User Verification Chart
function createUserVerificationChart(verificationData) {
    const ctx = document.getElementById('userVerificationChart').getContext('2d');

    // Destroy existing chart if it exists
    if (window.verificationChart instanceof Chart) {
        window.verificationChart.destroy();
    }

    window.verificationChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(verificationData),
            datasets: [{
                data: Object.values(verificationData),
                backgroundColor: [
                    '#20c997',  // Verified
                    '#ffc107',  // Unverified
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'User Verification Status'
                }
            }
        }
    });
}
</script>
{% endblock %}
